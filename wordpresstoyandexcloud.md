# Перенос сайта на Wordpress в Яндекс.Облако

С помощью этой инструкции вы научитесь переносить сайт на базе Wordpress с хостингом и доменом у сторонних провайдеров в инфраструктуру Yandex.Cloud. В результате вы получите рабочий сайт с доменом в инфраструктуре Yandex.Cloud.

[WordPress](https://ru.wordpress.org/) — свободно распространяемая система управления содержимым сайта с открытым исходным кодом, написанная на [PHP](https://www.php.net/), с сервером базы данных [MySQL](https://www.mysql.com/) и выпущенная под лицензией [GNU GPL версии 2](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html).

Чтобы перенести веб-сайт на базе WordPress в инфраструктуру Яндекс.Облака:

1. [Подготовьте облако к работе](#before-you-begin).

1. [Создайте виртуальную машину с предустановленным веб-сервером](#create-vm).

1. [Выполните полный бекап файлов сайта и базы данных](#make-backup).

1. [Подключитесь к виртуальной машине](#connect-to-VM).

1. [Установите и настройте phpMyAdmin](#install-and-setup-phpmyadmin).

1. [Импортируйте базу данных через phpMyAdmin в Яндекс.Облако](#import-phpmyadmin-to-yandexcloud).

1. [Перенесите файлы сайта](#move-files-to-yandexcloud).

1. [Настройте DNS](#DNS-yandexcloud).

1. [Создайте SSL-сертификат c помощью Let’s Encrypt](#SSL-yandexcloud).

1. [Проверьте работу сайта](#test-site).

Возможные проблемы при переносе сайта описаны в разделе [Возможные проблемы и пути их решения](troubleshooting).

Если сайт вам больше не нужен, [удалите все используемые им ресурсы](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

Перед тем, как разворачивать сервер, зарегистрируйтесь в {{ yandex-cloud }} и создайте платежный аккаунт:

{% include [prepare-register-billing](../../_includes/solutions/_common/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша ВМ, на [странице облака](https://console.cloud.yandex.ru/cloud).

[Подробнее об облаках и каталогах](../../resource-manager/concepts/resources-hierarchy.md).

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки сервера для сайта входит:

* плата за постоянно запущенную ВМ (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического или статического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).

## Создайте виртуальную машину с предустановленным веб-сервером {#create-vm}

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите пункт **Виртуальная машина**.
1. В поле **Имя** введите имя ВМ — произвольное название виртуальной машины. Имя должно соответствовать следующим требованиям:

   * Длина — от 3 до 63 символов.
   * Содержит строчные буквы латинского алфавита, цифры и дефисы.
   * Первый символ — буква. Последний символ — не дефис.

1. Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой должна находиться ВМ. Если вы не знаете, какая зона доступности вам нужна, оставьте выбранную по умолчанию.
1. В блоке **Образы из {{ marketplace-name }}** нажмите кнопку **Выбрать** и выберите образ ВМ с нужным набором компонентов — **LAMP** для Linux, Apache, MySQL, PHP.

1. В блоке **Вычислительные ресурсы**:
   * Выберите [платформу](../../compute/concepts/vm-platforms.md) ВМ.
   * Укажите необходимое количество vCPU и объем RAM.

   Для сайта Wordpress хватит минимальной конфигурации:

   * **Платформа** — Intel Ice Lake.
   * **Гарантированная доля vCPU** — 20%.
   * **vCPU** — 1.
   * **Диск** — Обычный.
   * **RAM** — 1 ГБ.

1. В блоке **Сетевые настройки** оставьте значения по умолчанию. Если нужной сети или подсети еще нет, вы можете создать их на странице создания ВМ.
1. В поле **Публичный адрес** оставьте значение **Автоматически**, чтобы назначить ВМ случайный внешний IP-адрес из пула {{ yandex-cloud }}. Выберите статический адрес из списка, если вы зарезервировали адрес заранее.
1. Укажите данные для доступа на ВМ:

   * В поле **Логин** введите имя пользователя.
   * В поле **SSH-ключ** вставьте содержимое файла открытого ключа.

     {% note info %}
     
     Пару ключей для подключения по SSH необходимо создать самостоятельно, см. раздел [{#T}](../../compute/operations/vm-connect/ssh.md).
     
     {% endnote %}

   Система назначит IP-адрес и имя хоста (FQDN) для подключения к ВМ.

     {% note warning %}

     Если вы выбрали вариант **Без адреса** в поле **Публичный адрес**, вы не сможете обращаться к ВМ с внешнего адреса.

     {% endnote %}

1. Нажмите кнопку **Создать ВМ**.

   Создание ВМ может занять несколько минут. Когда ВМ перейдет в статус `RUNNING`, вы можете [загрузить на нее файлы веб-сайта](#move-files-to-yandexcloud).

## Выполните полный бекап файлов сайта и базы данных {#make-backup}

Для подготовки сайта к переносу выполните полный бекап файлов сайта и базы данных на исходном хостинге. Пример — [бекап на хостинге Reg.ru](https://help.reg.ru/hc/ru/articles/4408046925201/).

## Подключитесь к виртуальной машине {#connect-to-VM}

{% include [ssh](../../_includes/solutions/web/ssh.md) %}

## Установите и настройте phpMyAdmin {#install-and-setup-phpmyadmin}

Порядок установки phpMyAdmin на виртуальной машине Яндекс.Облака:

1. Последовательно выполните в Терминале следующие команды:

    ```console
        $ sudo apt-get update
        $ sudo apt-get install phpmyadmin php-mbstring php-gettext
    ```

1. В окне выбора сервера установки phpMyAdmin выберите **Apache2**. Нажмите **Ok**.

    ![phpmyadminhttpserver](../../_assets/solutions/wordpresstoyandexcloud/myadmin1.png "Окно выбора HTTP-сервера для установки phpMyAdmin")

1. В окне настройки доступа к БД, нажмите **Yes** и задайте пароль администратора.

    ![phpmyadmindb](../../_assets/solutions/wordpresstoyandexcloud/myadmin2.png "Окно настройки доступа к базе данных")

1. Для получения пароля, сгенерированного при установке LAMP-образа, выполните команду в Терминале:

    ```console
    $ sudo cat /root/default_passwords.txt
    ```

   Система отобразит следующие данные:

    ```console
    user@user:~$ sudo cat /root/default_passwords.txt 
    MYSQL_PASS=PASSWORD 
    MYSQL_ROOT_PASS=ROOTPASSWORD 
    MYSQL_USER=wordpress 
    MYSQL_DB=wordpress

    Apache Web Auth:
      login: admin 
      password: ***************
    ```

    Сохраните данную информацию.

1. Для включения расширения PHP выполните команды:

    ```console
    $ sudo phpenmod mcrypt
    $ sudo phpenmod mbstring
    ```

1. Для перезапуска Apache и применения изменений выполните в Терминале команду:

    ```console
    $ sudo systemctl restart apache2
    ```

1. Запустите phpMyAdmin. Для этого откройте публичный IP-адрес вашего сайта и добавьте к нему `/phpmyadmin`:

   `http://0.0.0.0/phpmyadmin`, где `0.0.0.0` — публичный IP-адрес вашего сайта.

### Настройка безопасности phpMyAdmin {#security-phpmyadmin}

Для предотвращения сетевых атак задайте дополнительный пароль для входа в панель. Для этого выполните следующие действия:

1. Выполните в Терминале команду:

      ```console
      $ sudo nano /etc/apache2/conf-available/phpmyadmin.conf
      ```

1. Добавьте директиву `AllowOverride All` в следующем месте конфигурационного файла:

      ```console
      <Directory /usr/share/phpmyadmin>
      Options FollowSymLinks
      DirectoryIndex index.php
      AllowOverride All
      ```

    Для правки конфигурационных файлов используйте сторонние инструменты, например текстовый редактор `nano`.

1. Нажмите сочетание клавиш Ctrl+O и Enter для сохранения изменений и сочетание клавиш Ctrl+X для выхода из файла. Теперь возможность использования файла `.htaccess` включена в вашей конфигурации. Это файл, который дает возможность конфигурировать работу сервера в отдельных папках, не предоставляя доступа к главному конфигурационному файлу.
  
1. Для перезапуска Apache и применения изменений выполните в Терминале команду:

    ```console
    $ sudo systemctl restart apache2
    ```

1. Для создания файла `.htaccess` выполните в Терминале команду:

    ```console
    $ sudo nano /usr/share/phpmyadmin/.htaccess
    ```

1. В созданный файл добавьте следующую информацию:

    ```console
    AuthType Basic
    AuthName "Restricted Files"
    AuthUserFile /etc/phpmyadmin/.htpasswd
    Require valid-user
    ```

1. Нажмите сочетание клавиш Ctrl+O и Enter для сохранения изменений и сочетание клавиш Ctrl+X для выхода из файла.

1. Создайте файл `.htpasswd` — файл, в котором хранятся пароли для доступа к ресурсу веб-сервера Apache. Для этого выполните в Терминале команду:

    ```console
    $ sudo htpasswd -c /etc/phpmyadmin/.htpasswd username
    ```

     Вместо `username` введите придуманное вами имя пользователя. Введите придуманный вами пароль два раза. Сохраните эту информацию.

1. Для перезапуска Apache и применения изменений выполните в Терминале команду:

    ```console
    $ sudo systemctl restart apache2
    ```

1. Откройте в браузере `http://0.0.0.0/phpmyadmin`, где `0.0.0.0` — публичный IP-адрес вашего сайта.

Теперь при входе в phpMyAdmin вы дополнительно защищены от злоумышленников.

## Импортируйте базу данных через phpMyAdmin в Яндекс.Облако {#import-phpmyadmin-to-yandexcloud}

Для импорта базы данных выполните следующие действия:

1. Откройте файл конфигурации WordPress вашего сайта.

1. Распакуйте архив сайта в корневую папке и откройте файл `wp-config.php`. Он должен находится в корневой папке. Скопируйте из этого файла значения следующих параметров:

   * `define('DB_USER', 'UsernameTEST')`;

   * `define('DB_NAME', 'database_wordpress')`;

   * `define('DB_PASSWORD', 'MySecretPassword')`.

1. Скопируйте имя пользователя `UsernameTEST` и откройте в браузере `http://0.0.0.0/phpmyadmin`, где `0.0.0.0` — публичный IP-адрес вашего сайта.

1. Перейдите в раздел **Учетные записи пользователей** и добавьте учетную запись пользователя со следующими параметрами:

   * **Имя пользователя** — вставьте скопированное значение из файла `wp-config.php` после поля `'DB_USER'`.

   * **Имя хоста** — `%`.

   * **Пароль** — вставьте скопированное значение из файла `wp-config.php` после поля `'DB_PASSWORD'`.

   * **Глобальные привилегии** — установите **Отметить все**.

   Остальные параметры оставьте без изменений.

1. Нажмите **Вперед**. Система сохранит учетную запись пользователя.

1. В поле **Базы данных** → **Имя базы данных** вставьте скопированное из файла `wp-config.php` значение после поля `'DB_NAME'`.

1. Выберите кодировку `utf8_general_ci` и нажмите **Создать**.

1. Импортируйте базу данных из бекапа в новую базу данных. Для этого выберите в левом столбце окна созданную базу данных, нажмите **Импорт** и выберите ранее созданный бекап базы данных. Система импортирует вашу базу данных.

1. Для предотвращения сетевых атак отключите утилиту phpMyAdmin. Для этого выполните в Терминале команду:

    ```console
    $ sudo a2disconf phpmyadmin.conf && sudo /etc/init.d/apache2 restart
    ```

## Перенесите файлы сайта {#move-files-to-yandexcloud}

Для переноса файлов бекапа на виртуальную машину воспользуйтесь сторонним FTP-клиентом, например [FileZilla](https://filezilla-project.org/).

Для переноса выполните следующие действия:

1. Добавьте ваш сайт в FTP-клиент. Для этого введите публичный IP-адрес сайта.

1. Выберите тип протокола — STFP, тип входа — файл с ключом.

1. Выберите файл ключа из папки `/Users/Username/.ssh/`.

1. Подключитесь и введите кодовую фразу для файла ключей.

1. Задайте права доступа от имени владельца для папки `/var/www/html` на виртуальной машине. Для этого выполните в Терминале команду:

    ```console
    $ sudo chmod 777 /var/www/html
    ```

1. Скопируйте архив с бекапом сайта в папку `/var/www/html` и распакуйте его командой:

    ```console
    $ cd /var/www/html
    $ tar -xvf FILENAME.tar.gz
    ```

    FILENAME — имя вашего архива с бекапом.

1. Удалите файл `index.html` и архив с бекапом.

1. Восстановите права для папки `/html` и ее вложений. Для этого выполните в Терминале:

    ```console
    $ cd var/www/
    $ sudo find ./ -type d -exec chmod 0755 {} \;
    $ sudo find ./ -type f -exec chmod 0644 {} \;
    $ sudo chmod 600 wp-config.php
    ```

## Настройте DNS {#DNS-yandexcloud}

Удалите в системе исходного регистратора домена адреса DNS-серверов вашего сайта. В настройках управления зоны домена укажите публичный IP-адрес виртуальной машины в Яндекс.Облаке.

Если у вас есть зарегистрированное доменное имя, воспользуйтесь сервисом Cloud DNS для управления доменом.

{% include [configure-a-record-and-cname](../../_includes/solutions/web/configure-a-record-and-cname.md) %}

## Создайте SSL-сертификат c помощью Let’s Encrypt {#SSL-yandexcloud}

SSL-сертификат позволяет шифровать трафик между пользователем и сайтом. Это помогает избежать кражи персональных данных при их вводе на сайте.
Для установки SSL-сертификата воспользуйтесь [Let’s Encrypt](https://letsencrypt.org/ru/). Это центр сертификации, предоставляющий бесплатные SSL-сертификаты.

Для получения сертификата выполните следующие действия:

1. Установите необходимые зависимости. Для этого выполните в Терминале команду:

    ```console
    $ sudo apt-get update && sudo apt-get install software-properties-common
    ```

1. Добавьте репозитории `universe` and `certbot`:

    ```console
    $ sudo add-apt-repository universe && sudo add-apt-repository ppa:certbot/certbot
    ```

1. Установите клиент Let’s Encrypt:

    ```console
    $ sudo apt-get update && sudo apt-get install certbot python-certbot-apache
    ```

1. Для получения SSL-сертификата выполните команду:

   ```console
   $ sudo certbot --apache
   ```

    Введите название вашего домена.

1. В следующем окне подтвердите перенаправление всех страниц с HTTP на HTTPS.

1. Для установки автообновления сертификата выполните следующую команду:

    ```console
    $ sudo crontab -e
    ```

   Выберите первый пункт в открывшемся списке.

1. Добавьте в открывшийся файл следующую информацию:

    ```console
    30 2 * * 1 /usr/bin/certbot renew >> /var/log/le-renew.log
    ```

Теперь в системе запланирована регулярная задача с выполнением каждый понедельник в 2:30 ночи. Результат выполнения будет записан в лог-файл. Это позволит вам не пропустить обновление SSL-сертификата.

## Проверьте работу сайта {#test-site}

Чтобы проверить работу сайта, введите в браузере его IP-адрес или доменное имя:

* `http://<публичный IP-адрес виртуальной машины>`.
* `http://www.example.com`.

## Возможные проблемы и пути их решения {#troubleshooting}

### Превышение установленного размера бекапа базы данных {#BD-oversize}

При превышении установленного по умолчанию лимита на размер бекапа базы данных в 2МБ система отобразит ошибку.
Для решения этой проблемы отредактируйте файл конфигурации `php.ini` на виртуальной машине:

1. Выполните в Терминале команду:

    ```console
    $ sudo nano /etc/php/7.0/apache2/php.ini
    ```

1. В открывшемся файле отредактируйте следующие параметры:

   * `upload_max_filesize` — максимальный размер загружаемого файла. Установите значение `80M`.

   * `post_max_size` — максимальный размер сообщения, передаваемого методом POST. Установите значение `80M`.

1. Нажмите сочетание клавиш Ctrl+O и Enter для сохранения изменений и сочетание клавиш Ctrl+X для выхода из файла.

1. Для перезапуска Apache и применения изменений выполните в Терминале команду:

    ```console
    $ sudo systemctl restart apache2
    ```

1. Откройте в браузере `http://0.0.0.0/phpmyadmin`, где `0.0.0.0` — публичный IP-адрес вашего сайта и повторите операцию импорта БД.

### Проблемы с открытием внутренних страниц WordPress сайта {#Wordpress-Problem}

При переносе вы можете столкнуться с недоступностью внутренних ссылок сайта.
Для решения этой проблемы выполните следующие действия:

1. Проверьте наличие файла `.htaccess` в корневой папке вашего сайта — `/var/www/html/.htaccess`. Если файл отсутствует, создайте его. Для этого выполните в Терминале команду:

    ```console
    $ sudo nano /var/www/html/.htaccess
    ```

1. Добавьте в созданный файл следующую информацию:

   ```console
   <IfModule mod_rewrite.c>
      RewriteEngine On
      RewriteBase /
      RewriteRule ^index\.php$ - [L]
      RewriteCond %{REQUEST_FILENAME} !-f
      RewriteCond %{REQUEST_FILENAME} !-d
      RewriteRule . /index.php [L]
   </IfModule>
   ```

1. Нажмите сочетание клавиш Ctrl+O и Enter для сохранения изменений и сочетание клавиш Ctrl+X для выхода из файла.

1. Откройте в браузере `http://0.0.0.0/phpmyadmin`, где `0.0.0.0` — публичный IP-адрес вашего сайта и проверьте корректность работы внутренних ссылок. 

Если проблема не решена, выполните следующие действия:

1. Включите поддержку файла `.htaccess` в Apache. Для этого выполните в Терминале команду:

    ```console
    $ sudo nano /etc/apache2/sites-available/000-default.conf
    ```

1. Добавьте в файл следующую информацию после строчки `DocumentRoot /var/www/html`:

    ```console
      <Directory /var/www/html>
         AllowOverride All
         Order allow,deny
         allow from all
      </Directory>
    ```

1. Для перезапуска Apache и применения изменений выполните в Терминале команду:

    ```console
    $ sudo service apache2 restart
    ```

1. Проверьте еще раз корректность работы внутренних ссылок.

## Как удалить созданные ресурсы

Чтобы перестать платить за развернутый сервер, достаточно [удалить](../../compute/operations/vm-control/vm-delete.md) виртуальную машину.

Если вы зарезервировали статический публичный IP-адрес специально для этой ВМ:

1. Откройте сервис **{{ vpc-name }}** в вашем каталоге.
1. Перейдите на вкладку **IP-адреса**.
1. Найдите нужный адрес, нажмите значок ![ellipsis](../../_assets/options.svg) и выберите пункт **Удалить**.
